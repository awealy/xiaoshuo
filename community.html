<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>社区中心 - 小说阅读平台</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
</head>
<body class="bg-gray-100">
  <header class="bg-white shadow-sm p-4 flex justify-between items-center">
    <h1 class="text-xl font-semibold">社区中心</h1>
    <a href="index.html" class="px-3 py-1 border rounded hover:bg-gray-100">返回首页</a>
  </header>

  <main class="max-w-5xl mx-auto p-6 grid grid-cols-1 md:grid-cols-3 gap-6">
    <!-- 群聊 -->
    <section class="bg-white p-4 rounded shadow-md col-span-2">
      <h2 class="text-lg font-bold mb-3">公共群聊</h2>
      <div id="chat-box" class="border p-3 h-80 overflow-y-auto bg-gray-50 rounded text-sm"></div>
      <div class="flex mt-3">
        <input id="chat-input" class="flex-1 border rounded-l px-2 py-1" placeholder="说点什么..." />
        <button id="send-chat" class="bg-indigo-500 text-white px-4 rounded-r">发送</button>
      </div>
    </section>

    <!-- 私信 -->
    <section class="bg-white p-4 rounded shadow-md">
      <h2 class="text-lg font-bold mb-3">私信</h2>
      <input id="receiver" class="w-full border px-2 py-1 rounded mb-2" placeholder="对方用户名">
      <textarea id="pm-input" class="w-full border rounded p-2 text-sm mb-2" rows="3" placeholder="输入私信内容"></textarea>
      <button id="send-pm" class="w-full bg-green-500 text-white rounded py-1">发送私信</button>
      <div id="pm-list" class="mt-3 text-sm text-gray-600 overflow-y-auto max-h-60"></div>
    </section>
  </main>

  <script>
    const SUPABASE_URL = "https://你的项目.supabase.co";
    const SUPABASE_KEY = "你的anon公钥";
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const userName = prompt("请输入你的昵称：") || "匿名";

    // 加载群聊消息
    async function loadChat() {
      const { data } = await supabase.from("messages").select("*").eq("room", "public").order("created_at", { ascending: true });
      const box = document.getElementById("chat-box");
      box.innerHTML = data.map(m => `<p><b>${m.user_name}：</b>${m.message}</p>`).join("");
      box.scrollTop = box.scrollHeight;
    }

    // 发送群聊
    document.getElementById("send-chat").onclick = async () => {
      const msg = document.getElementById("chat-input").value.trim();
      if (!msg) return;
      await supabase.from("messages").insert([{ room: "public", user_name: userName, message: msg }]);
      document.getElementById("chat-input").value = "";
      loadChat();
    };

    // 实时监听群聊更新
    supabase.channel("room_public")
      .on("postgres_changes", { event: "*", schema: "public", table: "messages" }, loadChat)
      .subscribe();

    loadChat();

    // 发送私信
    document.getElementById("send-pm").onclick = async () => {
      const receiver = document.getElementById("receiver").value.trim();
      const msg = document.getElementById("pm-input").value.trim();
      if (!receiver || !msg) return alert("请填写接收者和消息内容");
      await supabase.from("private_messages").insert([{ sender: userName, receiver, message: msg }]);
      document.getElementById("pm-input").value = "";
      loadPM();
    };

    // 加载私信
    async function loadPM() {
      const { data } = await supabase.from("private_messages")
        .select("*")
        .or(`sender.eq.${userName},receiver.eq.${userName}`)
        .order("created_at", { ascending: true });
      document.getElementById("pm-list").innerHTML =
        data.map(m => `<p><b>${m.sender} → ${m.receiver}：</b>${m.message}</p>`).join("");
    }

    // 实时监听私信
    supabase.channel("private_messages")
      .on("postgres_changes", { event: "*", schema: "public", table: "private_messages" }, loadPM)
      .subscribe();

    loadPM();
  </script>
</body>
</html>
